---
title: V8ä¸­çš„å¿«æ…¢æ•°ç»„ï¼ˆé™„æºç åˆ†æã€å›¾æ–‡æ›´æ˜“ç†è§£ğŸ˜ƒï¼‰
date: 2022-08-10 19:53:43
tags:
---

> æ¥ä¸Šä¸€ç¯‡ [V8 ä¸­çš„å¿«æ…¢å±æ€§](https://juejin.cn/post/7125763016582234142)ï¼Œæœ¬ç¯‡åˆ†æV8 ä¸­çš„å¿«æ…¢æ•°ç»„ï¼Œäº†è§£æ•°ç»„å…¨å¡«å……è¿˜æ˜¯å¸¦å­”ã€å¿«æ…¢æ•°ç»„ã€å¿«æ…¢è½¬åŒ–ã€åŠ¨æ€æ‰©ç¼©å®¹ç­‰ç­‰ã€‚å…¶å®å¾ˆå¤šè¯­è¨€åº•å±‚éƒ½é‡‡ç”¨ç±»ä¼¼çš„å¤„ç†æ–¹å¼ï¼Œæ¯”å¦‚ï¼šGolangä¸­åˆ‡ç‰‡çš„appendæ“ä½œå°±æ¶‰åŠæ‰©å®¹å¤„ç†ã€‚

ğŸ D8è°ƒè¯•å·¥å…·ä½¿ç”¨è¯·æ¥[è¿™é‡Œ](https://juejin.cn/post/7126505899337711647)

# 1ã€å…¨å¡«å…… or å¸¦å­”

é€šè¿‡ä¸€ä¸ªå°æå­ï¼Œçœ‹ä¸€ä¸‹ä»€ä¹ˆæ˜¯å…¨å¡«å……æ•°ç»„(`Paked-Array`)ï¼Œä»€ä¹ˆæ˜¯å¸¦å­”æ•°ç»„(`Holey-Array`)

å‰é¢è¿˜å†™äº†**ç¨€ç–æ•°ç»„**ï¼Œç¨€ç–æ•°ç»„æ›´åŠ å…·æœ‰ä¸šåŠ¡åº”ç”¨æ€§ï¼Œæ¸…æ´—çš„æ˜¯æ— æ„ä¹‰çš„æ•°æ®ï¼Œå¯ä»¥å¯¹æ¯”å¸¦å­”æ•°ç»„æ¥åˆ†æä¸€ä¸‹ï¼Œæœ‰å…´è¶£è¯·çœ‹ğŸ‘‰ [ç¨€ç–æ•°ç»„â€”â€”å®ç°äº”å­æ£‹å­˜ç›˜å’Œç»­ä¸Šç›˜åŠŸèƒ½](https://juejin.cn/post/7124557913921847327)

```js
const o = ['a', 'b', 'c']
console.log(o[1])          // 'b'

delete o[1]
console.log(o[1])          // undefined
o.__proto__ = { 1: 'B' }
console.log(o[0])          // 'a'
console.log(o[1])          // 'B'   ä½†å¦‚ä½•ç¡®å®šè¦è®¿é—®åŸå‹é“¾ï¼Ÿï¼ŸğŸ¤”
console.log(o[2])          // 'c'
console.log(o[3])          // undefined
```

å¦‚æœä¸€ä¸ªæ•°ç»„ä¸­æ‰€æœ‰ä½ç½®å‡æœ‰å€¼ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º`å…¨å¡«å……`ï¼ˆ**Packed**ï¼‰æ•°ç»„ï¼›

è‹¥æŸäº›ä½ç½®åœ¨åˆå§‹åŒ–æ—¶æœªå®šä¹‰ï¼ˆå¦‚Â `const arr = [1, , 3]`Â ä¸­çš„ arr[1]ï¼‰ï¼Œæˆ–å®šä¹‰åè¢«åˆ é™¤ï¼ˆdeleteï¼Œå¦‚ä¸Šè¿°ä¾‹å­ï¼‰ï¼Œç§°ä¹‹ä¸º`å¸¦å­”`ï¼ˆ**Holey**ï¼‰æ•°ç»„ã€‚

è¯¥ä¾‹å­åœ¨ V8 çš„è®¿é—®å¯ä»¥é€šè¿‡ä¸‹å›¾è§£é‡Šï¼š

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/819317cc4d4142bea00e155929af1fae~tplv-k3u1fbpfcp-watermark.image?)

ä¸€å¼€å§‹æ•°ç»„ o æ˜¯ packed çš„ï¼Œæ‰€ä»¥è®¿é—® o[1] æ—¶å¯ä»¥ç›´æ¥è·å–å€¼ï¼Œè€Œä¸éœ€è¦è®¿é—®åŸå‹ã€‚

è€Œè¡Œ 4ï¼š`delete o[1]`Â ä¸ºæ•°ç»„å¼•å…¥äº†ä¸€ä¸ªå­”æ´ï¼ˆ`the_hole`ï¼‰ï¼Œç”¨äºæ ‡è®°ä¸å­˜åœ¨çš„å±æ€§ï¼ŒåŒæ—¶åˆè¡Œ 6 ä¸º o å®šä¹‰äº†åŸå‹ä¸Šçš„ 1 å±æ€§ï¼Œå½“å†æ¬¡è·å– o[1] æ—¶ä¼š**ç©¿å­”**è¿›è€Œç»§ç»­å¾€åŸå‹é“¾ä¸ŠæŸ¥è¯¢ã€‚åŸå‹é“¾ä¸Šçš„æŸ¥è¯¢æ˜¯æ˜‚è´µçš„ï¼Œ*å¯ä»¥æ ¹æ®æ˜¯å¦æœ‰ the_hole æ¥é™ä½è¿™éƒ¨åˆ†æŸ¥è¯¢å¼€é”€*ã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5cd8c5fcb1764d669c875a742877de72~tplv-k3u1fbpfcp-watermark.image?)

# 2ã€å¿«æ…¢æ•°ç»„

```js
const arr = [1, 2, 3]
arr[1999] = 1999
// arr ä¼šå¦‚ä½•å­˜å‚¨ï¼Ÿ
```

è¿™ä¸ªä¾‹å­ä¸­ï¼Œåœ¨è¡Œ 1 å£°æ˜å®Œæ¯•å arr æ˜¯ä¸€ä¸ªå…¨å¡«å……çš„æ•°ç»„ï¼Œä½†åœ¨è¡Œ 2 é©¬ä¸Šåˆå®šä¹‰ç´¢å¼• 1999 å¤„å€¼ä¸º 1999ï¼Œæ­¤æ—¶å¦‚æœä¸º arr åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º 2000 çš„å®Œæ•´æ•°ç»„æ¥å­˜å‚¨è¿™æ ·çš„ç¨€ç–æ•°æ®å°†ä¼šéå¸¸å ç”¨å†…å­˜ï¼Œä¸ºäº†åº”å¯¹è¿™ç§æƒ…å†µï¼ŒV8 ä¼šå°†æ•°ç»„é™çº§ä¸º`æ…¢æ•°ç»„`ï¼Œåˆ›å»ºä¸€ä¸ªå­—å…¸æ¥å­˜å‚¨`ã€Œé”®ã€å€¼ã€æè¿°ç¬¦ã€`ï¼ˆ**keyã€valueã€descriptor**ï¼‰ ä¸‰å…ƒç»„ã€‚è¿™å°±æ˜¯Â `Object.defineProperty(object, key, descriptor)`Â API åŒæ ·ä¼šåšçš„äº‹æƒ…ã€‚

> 1. é‰´äºæˆ‘ä»¬æ²¡æœ‰åŠæ³•åœ¨ JavaScript çš„ API å±‚é¢è®© V8 æ‰¾åˆ° HiddenClass å¹¶å­˜å‚¨å¯¹åº”çš„ descriptor ä¿¡æ¯ï¼Œæ‰€ä»¥å½“ä½¿ç”¨Â `Object.defineProperty`Â è‡ªå®šä¹‰ keyã€valueã€descriptor æ—¶ï¼ŒV8 éƒ½ä¼šä½¿ç”¨æ…¢å±æ€§ï¼Œå¯¹åº”åˆ°æ•°ç»„ä¸­å°±æ˜¯æ…¢æ•°ç»„ã€‚
>
> 2. `Object.defineProperty`Â æ˜¯ Vue 2 çš„æ ¸å¿ƒ APIï¼Œå½“å¯¹è±¡æˆ–æ•°ç»„å¾ˆåºå¤§æ—¶ï¼Œä¸å¯é¿å…åœ°å¯¼è‡´è®¿é—®é€Ÿåº¦ä¸‹é™ï¼Œè¿™æ˜¯åº•å±‚åŸç†å†³å®šçš„ã€‚

é‚£ç©¶ç«Ÿä»€ä¹ˆæ˜¯å¿«æ•°ç»„å’Œæ…¢æ•°ç»„å‘¢ï¼Ÿæˆ‘ä»¬çœ‹ä¸‹V8åº•å±‚å¯¹äºæ•°ç»„çš„å®šä¹‰ï¼šğŸ‘‰ [æºä»£ç ï¼šv8/src/objects/js-array.h](https://source.chromium.org/chromium/chromium/src/+/master:v8/src/objects/js-array.h)


![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c62c161602f244b0b516b57a50e65b88~tplv-k3u1fbpfcp-watermark.image?)

-   å¿«æ¨¡å¼ï¼šæ•°ç»„å®ç°çš„æ˜¯ V8 é‡Œä¸€ä¸ªå«Â `FixedArray`Â çš„ç±»ï¼Œå®ƒåœ¨å†…å­˜ä¸­æ˜¯**è¿ç»­çš„ç©ºé—´**ï¼Œç›´æ¥é€šè¿‡ç´¢å¼•è¯»å†™å€¼ï¼Œéå¸¸å¿«ã€‚å¦‚æœæœ‰ push æˆ– pop æ“ä½œï¼Œå®ƒä¼šåŠ¨æ€åœ°æ‰©å®¹æˆ–æ”¶ç¼©ã€‚

-   æ…¢æ¨¡å¼ï¼šå¦‚å‰æ–‡æ‰€ä»‹ç»ï¼ŒV8 åˆ›å»ºäº†ä¸€ä¸ªå­—å…¸ï¼ˆ`HashTable`ï¼‰æ¥è®°å½•æ˜ å°„å…³ç³»ï¼Œå…¶ä¸­ç´¢å¼•çš„æ•´æ•°å€¼å³æ˜¯å­—å…¸çš„é”®ã€‚

## ä¸ºä»€ä¹ˆæ•°ç»„ä¹Ÿæ˜¯å¯¹è±¡ç±»å‹çš„ï¼Ÿ

åœ¨ V8 æºç ä¸­æ¸…æ™°åœ°è¡¨æ˜ï¼ŒJSArray ç»§æ‰¿è‡ª JSObjectï¼Œå³æ•°ç»„æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œè€Œ JS ä¸­æ‰€æœ‰éåŸå§‹ç±»å‹éƒ½æ˜¯å¯¹è±¡çš„å®ä¾‹ï¼Œæ‰€ä»¥ JS ä¸­æ•°ç»„å¯ä»¥å­˜å‚¨å¤šç§ç±»å‹çš„å€¼ã€‚

æ•°ç»„å†…éƒ¨ä¹Ÿæ˜¯ç”¨key-valueçš„å­˜å‚¨å½¢å¼

```js
const testArr = [1, "hello", true, function () {
  return 1;
}];
```

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/540021a06a2e43379f6141d37d450b75~tplv-k3u1fbpfcp-watermark.image?)

## 2.1ã€å¿«æ•°ç»„ä½•æ—¶è½¬æ¢ä¸ºæ…¢æ•°ç»„

### (1)ã€çœ‹ä¸€ä¸‹æºç å…ˆğŸ‘‡

1. path:v8/src/objects/js-objects-inl.h

    å¿«æ…¢æ¨¡å¼è½¬åŒ–ï¼š `ShouldConvertToSlowElements`

```
// path:v8/src/objects/js-objects-inl.h

// If the fast-case backing storage takes up much more memory than a dictionary
// backing storage would, the object should have slow elements.
// static
static inline bool ShouldConvertToSlowElements(uint32_t used_elements,
                                               uint32_t new_capacity) {
  uint32_t size_threshold = NumberDictionary::kPreferFastElementsSizeFactor *
                            NumberDictionary::ComputeCapacity(used_elements) *
                            NumberDictionary::kEntrySize;
  return size_threshold <= new_capacity;
}

static inline bool ShouldConvertToSlowElements(JSObject object,
                                               uint32_t capacity,
                                               uint32_t index,
                                               uint32_t* new_capacity) {
  STATIC_ASSERT(JSObject::kMaxUncheckedOldFastElementsLength <=
                JSObject::kMaxUncheckedFastElementsLength);
  if (index < capacity) {
    *new_capacity = capacity;
    return false;
  }
  if (index - capacity >= JSObject::kMaxGap) return true;
  *new_capacity = JSObject::NewElementsCapacity(index + 1);
  DCHECK_LT(index, *new_capacity);
  if (*new_capacity <= JSObject::kMaxUncheckedOldFastElementsLength ||
      (*new_capacity <= JSObject::kMaxUncheckedFastElementsLength &&
       ObjectInYoungGeneration(object))) {
    return false;
  }
  return ShouldConvertToSlowElements(object.GetFastElementsUsage(),
                                     *new_capacity);
}
```

### (2)ã€åˆ†æ

-   å¦‚æœå¿«æ•°ç»„æ‰©å®¹åçš„å®¹é‡æ˜¯åŸæ¥çš„Â **3 å€ä»¥ä¸Š**ï¼Œæ„å‘³ç€å®ƒæ¯”Â `HashTable`Â å½¢å¼å­˜å‚¨å ç”¨æ›´å¤§çš„å†…å­˜ï¼Œå¿«æ•°ç»„ä¼šè½¬æ¢ä¸ºæ…¢æ•°ç»„

-   å¦‚æœå¿«æ•°ç»„æ–°å¢çš„ç´¢å¼•ä¸åŸæ¥æœ€å¤§ç´¢å¼•çš„å·®å€¼å¤§äº 1024ï¼Œå¿«æ•°ç»„ä¼šè¢«è½¬æ¢ä¼šæ…¢æ•°ç»„

æ‰€ä»¥ï¼Œå‰é¢çš„ä¾‹å­ï¼š

```js
const arr = [1, 2, 3];
arr[1999] = 1999;
%DebugPrint(arr);
```

`1999 - 2 > 1024`ï¼Œarr ä»å¿«æ•°ç»„è½¬æ¢ä¸ºå“ˆå¸Œå½¢å¼å­˜å‚¨çš„æ…¢æ•°ç»„ã€‚

ä¸‹é¢çœ‹ä¸€ä¸‹è¯¦ç»†è¿è¡Œä¿¡æ¯ğŸ‘‡

- ä¿®æ”¹arrä¹‹å‰:

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bae16e0c9bcb4866a16f15ad5b71f53f~tplv-k3u1fbpfcp-watermark.image?)

- ä¿®æ”¹arrä¹‹åï¼š
![9c1a1af43947b4da39b9c554d56c312.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/05f44d5f19f840c4a7aa25eba2aef089~tplv-k3u1fbpfcp-watermark.image?)


## 2.2ã€æ…¢æ•°ç»„ä½•æ—¶è½¬æ¢ä¸ºå¿«æ•°ç»„

### (1)ã€çœ‹ä¸€ä¸‹æºç å…ˆğŸ‘‡

1. path:v8/src/objects/js-objects.cc

```
// path:v8/src/objects/js-objects.cc

// line:4932
static bool ShouldConvertToFastElements(JSObject object,
                                        NumberDictionary dictionary,
                                        uint32_t index,
                                        uint32_t* new_capacity) {
  // If properties with non-standard attributes or accessors were added, we
  // cannot go back to fast elements.
  if (dictionary.requires_slow_elements()) return false;

  // Adding a property with this index will require slow elements.
  if (index >= static_cast<uint32_t>(Smi::kMaxValue)) return false;

  if (object.IsJSArray()) {
    Object length = JSArray::cast(object).length();
    if (!length.IsSmi()) return false;
    *new_capacity = static_cast<uint32_t>(Smi::ToInt(length));
  } else if (object.IsJSArgumentsObject()) {
    return false;
  } else {
    *new_capacity = dictionary.max_number_key() + 1;
  }
  *new_capacity = std::max(index + 1, *new_capacity);

  uint32_t dictionary_size = static_cast<uint32_t>(dictionary.Capacity()) *
                             NumberDictionary::kEntrySize;

  // çœ‹è¿™é‡ŒğŸ‘‡ï¼Œ å½“æ…¢æ•°ç»„è½¬æ¢æˆå¿«æ•°ç»„èƒ½èŠ‚çœ ä¸å°‘äº 50%Â çš„ç©ºé—´æ—¶ï¼Œæ‰ä¼šå°†å…¶è½¬æ¢
  // Turn fast if the dictionary only saves 50% space.
  return 2 * dictionary_size >= *new_capacity;
}
```

### (2)ã€åˆ†æ

å…ƒç´ èƒ½å­˜æ”¾åœ¨å¿«æ•°ç»„ä¸­å¹¶ä¸”é•¿åº¦ä¸åœ¨smiä¹‹é—´ï¼ˆ64ä½-2^31åˆ°2^32-1ï¼‰ï¼Œå¹¶ä¸”å½“å‰æ…¢æ•°ç»„ç©ºé—´ç›¸æ¯”å¿«æ•°ç»„èŠ‚çœå€¼å°äºç­‰äº50%ï¼Œåˆ™è½¬å˜æˆä¸ºå¿«æ•°ç»„ã€‚

## å¿«æ…¢è½¬æ¢æ€»ç»“

-   å¿«æ•°ç»„å°±æ˜¯ä»¥ç©ºé—´æ¢æ—¶é—´çš„æ–¹å¼ï¼Œç”³è¯·äº†å¤§å—è¿ç»­å†…å­˜ï¼Œæé«˜äº†æ‰§è¡Œæ•ˆç‡ã€‚

-   æ…¢æ•°ç»„ä»¥æ—¶é—´æ¢ç©ºé—´ï¼Œä¸å¿…ç”³è¯·è¿ç»­çš„ç©ºé—´ï¼ŒèŠ‚çœäº†å†…å­˜ï¼Œä½†éœ€è¦ä»˜å‡ºæ•ˆç‡å˜å·®çš„ä»£ä»·ã€‚

# 3ã€åŠ¨æ€æ‰©å®¹ä¸æ”¶ç¼©

## 3.1ã€æ‰©å®¹

çœ‹ä¸‹æºç ğŸ‘‡

1. path:v8/src/objects/js-array.h

    ç©ºæ•°ç»„é¢„åˆ†é…çš„å¤§å°: 4

```
// path:v8/src/objects/js-array.h

// Dispatched behavior.
DECL_PRINTER(JSArray)
DECL_VERIFIER(JSArray)

// Number of element slots to pre-allocate for an empty array.
// ç©ºæ•°ç»„é¢„åˆ†é…çš„å¤§å°ä¸º4
static const int kPreallocatedArrayElements = 4;

static const int kLengthDescriptorIndex = 0;
```

ä¸Šé¢ä»£ç è¡¨æ˜ï¼Œå½“å£°æ˜ä¸€ä¸ªç©ºæ•°ç»„æ—¶ï¼Œå·²é¢„åˆ†é…å¥½ 4 ä¸ªå­—èŠ‚çš„å­˜å‚¨ç©ºé—´ã€‚

æ‰€ä»¥ [] ä¸ [1, 2, 3, 4] å ç”¨ä¸€æ ·å¤šçš„å†…å­˜ã€‚ å‰é¢è¯´è¿‡ï¼ŒJSArray ç»§æ‰¿è‡ª JSObjectï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ js-objects.h ä¸­æ‰¾åˆ°å¦‚ä¸‹ä»£ç ï¼š


2. path:v8/src/objects/js-objects.h

    æ‰©å®¹å…¬å¼

```
// path:v8/src/objects/js-objects.h

// line:551ğŸ‘‡
static const uint32_t kMinAddedElementsCapacity = 16;

// Computes the new capacity when expanding the elements of a JSObject.
static uint32_t NewElementsCapacity(uint32_t old_capacity) {
  // (old_capacity + 50%) + kMinAddedElementsCapacity
  // æ‰©å®¹å…¬å¼:åŸæœ‰å†…å­˜å®¹é‡ï¼ˆ1.5å€ï¼‰+ 16
  return old_capacity + (old_capacity >> 1) + kMinAddedElementsCapacity;
}
```

è¿™æ˜¯å¯¹ JSObject elements æ‰©å®¹å’Œå¯¹ JSArray æ‰©å®¹çš„é€šç”¨æ–¹æ³•ã€‚æ‰©å®¹åå®¹é‡çš„è®¡ç®—é€»è¾‘æ˜¯ï¼š**åœ¨åŸå ç”¨ç©ºé—´ old_capacity çš„åŸºç¡€ä¸Šå¢åŠ ä¸€åŠï¼ˆold_capacity >> 1 å³ç§» 1 ä½è¡¨ç¤ºé™¤ 2ï¼Œå†ç›¸åŠ å¾—åŸç©ºé—´ 1.5 å€ï¼‰ï¼Œå†åŠ ä¸Š 16**ã€‚

**ä¸¾ä¾‹ï¼š**
```js
const arr = [1, 2, 3, 4];
arr.push(5);
%DebugPrint(arr);
```

- arr.push ä¹‹å‰ï¼š
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/469c1808dc7f4a288a507e3d77c0e20e~tplv-k3u1fbpfcp-watermark.image?)

- arr.push åï¼š

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d059832a1fd5480da0b6e62b224ef908~tplv-k3u1fbpfcp-watermark.image?)

**å…·ä½“åˆ†æå¦‚ä¸‹ï¼š**
ğŸ‘‡

1. å‘æ•°ç»„ [1, 2, 3, 4] push 5 æ—¶ï¼Œé¦–å…ˆåˆ¤æ–­åˆ°å½“å‰å®¹é‡å·²æ»¡ï¼Œéœ€è¦è®¡ç®—æ–°å®¹é‡ã€‚

2. old_capacity = 4ï¼Œnew_capacity = 4 + 4 >> 1 + 16 = 22ï¼Œå¾—å‡º [1, 2, 3, 4, 5] çš„å®¹é‡ä¸º 22 ä¸ªå­—èŠ‚ï¼Œ

3. V8 å‘æ“ä½œç³»ç»Ÿç”³è¯·ä¸€å—è¿ç»­å¤§å°ä¸º 22 å­—èŠ‚çš„å†…å­˜ç©ºé—´ï¼Œéšåå°†è€æ•°æ®ä¸€ä¸€ copyï¼Œå†æ–°å°†æ–°å¢å…ƒç´ å†™å…¥ã€‚

## 3.2 ç¼©å®¹

ç´§æ¥ç€ï¼Œæˆ‘ä»¬åœ¨Â `src/objects/elements.cc`Â ä¸­æ‰¾åˆ°Â `SetLengthImpl`Â æ–¹æ³•ä¸­çš„å¦‚ä¸‹ä»£ç ï¼š

```
// path:src/objects/elements.cc

// line:750
if (2 * length + JSObject::kMinAddedElementsCapacity <= capacity) {
  // If more than half the elements won't be used, trim the array.
  // Do not trim from short arrays to prevent frequent trimming on
  // repeated pop operations.
  // Leave some space to allow for subsequent push operations.
  int elements_to_trim = length + 1 == old_length
                             ? (capacity - length) / 2
                             : capacity - length;
  isolate->heap()->RightTrimFixedArray(*backing_store, elements_to_trim);
  // Fill the non-trimmed elements with holes.
  BackingStore::cast(*backing_store)
      .FillWithHoles(length,
                     std::min(old_length, capacity - elements_to_trim));
} else {
  // Otherwise, fill the unused tail with holes.
  BackingStore::cast(*backing_store).FillWithHoles(length, old_length);
}
```

å½“æ•°ç»„å…ƒç´ å‡å°‘ï¼ˆå¦‚ popï¼‰åï¼Œå¦‚æœæ•°ç»„å®¹é‡å¤§äºç­‰äº length çš„ 2 å€ï¼Œåˆ™è¿›è¡Œå®¹é‡è°ƒæ•´ï¼Œä½¿ç”¨Â `RightTrimFixedArray`Â å‡½æ•°ï¼Œè®¡ç®—å‡ºéœ€è¦é‡Šæ”¾çš„ç©ºé—´å¤§å°ï¼Œåšå¥½æ ‡è®°ï¼Œç­‰å¾… GC å›æ”¶ï¼›å¦‚æœæ•°ç»„å®¹é‡å°äº length çš„ 2 å€ï¼Œåˆ™ç”¨ holes å¯¹è±¡å¡«å……ã€‚


# æ€»ç»“ï¼š

1. æ•°ç»„å…ƒç´ å°‘çš„æ—¶å€™æ˜¯çº¿æ€§ç»“æ„å­˜å‚¨ï¼ˆFixedArrayï¼‰çš„ï¼Œå†…å­˜åœ°å€è¿ç»­ï¼ŒæŸ¥æ‰¾é€Ÿåº¦å¿«ï¼Œå¯ä»¥åŠ¨æ€æ‰©ç¼©å®¹ï¼›

2. æ•°ç»„å…ƒç´ å¤šçš„æ—¶å€™è½¬åŒ–ä¸ºæ…¢æ•°ç»„ï¼Œé€šè¿‡åˆ›å»ºäº†ä¸€ä¸ªå­—å…¸æ¥è®°å½•æ˜ å°„å…³ç³»ï¼Œå†…å­˜ä¸è¿ç»­ï¼Œé€šè¿‡å¤§åé¼é¼çš„Object.defineProperty(object, key, descriptor)åˆ›å»º

jsçš„æ•°ç»„çœ‹ä¼¼ä¸åŒï¼Œå…¶å®åªæ˜¯V8 åœ¨åº•å±‚å®ç°ä¸Šåšäº†ä¸€å±‚å°è£…ï¼Œä½¿ç”¨ä¸¤ç§æ•°æ®ç»“æ„å®ç°æ•°ç»„ï¼Œå¹¶ä¸”é€šè¿‡æ—¶é—´å’Œç©ºé—´2ä¸ªçº¬åº¦çš„å–èˆï¼Œä¼˜åŒ–äº†æ•°ç»„çš„æ€§èƒ½ã€‚

[å‚è€ƒå­¦ä¹ åšå®¢](https://z3rog.tech/blog/2020/fast-properties.html)

---

ğŸˆğŸˆğŸˆ

ğŸŒ¹ å…³æ³¨æˆ‘ï¼Œä½ ä¼šå‘ç°ä¸€ä¸ªè¸å®åŠªåŠ›çš„å®è—å‰ç«¯ğŸ˜Šï¼Œè®©æˆ‘ä»¬ä¸€èµ·å­¦ä¹ ï¼Œå…±åŒæˆé•¿å§ã€‚

ğŸ‰ å–œæ¬¢çš„å°ä¼™ä¼´è®°å¾—**ç‚¹èµå…³æ³¨æ”¶è—**å“Ÿï¼Œå›çœ‹ä¸è¿·è·¯ ğŸ˜‰

âœ¨ æ¬¢è¿å¤§å®¶è½¬å‘ã€è¯„è®ºäº¤æµ

ğŸ èŸ¹èŸ¹ğŸ˜Š
